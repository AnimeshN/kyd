{% extends 'dashboard/dash_base.html' %}

{% load static %}



{% block feature_css %}



<style>

    .heading{

        font-weight: bold;

        font-size: 34px;

    }

    p{

        font: 20px sans-serif;

    }

    img{

        width: 30px;

        height:30px;

    }



    html, body {

     height: 100%;

    }

    #table {width: 90%;

    height: 75%;

    font-size: large;

   }

    th{

        border:2px solid black;

        font-weight: bolder;

        text-align: center;

      }   

td {border:2px solid black;

text-align: center;}



#tooltip {

position: absolute;

width: 370px;

height: auto;

padding: 10px;



background-color: white;

-webkit-border-radius: 10px;

-moz-border-radius: 10px;

border-radius: 10px;

-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);

-mox-box-shadow: 4px 4px 4px 10px rgba(0, 0, 0, 0.4);

box-shadow: 4px 4px 10px rbga(0, 0, 0, 0.4); pointer-events: none;

}



.tooltip.hidden {

opacity: 0;

}

#tooltip p {

margin: 0;

font-family: sans-serif;

font-size: 20px;

line-height: 20px;

}

 

</style>



{% endblock %}



{% block feature %}

<div class='heading text-dark mt-2 text-center'  id="barTitle"><span id="bartitleCategory">Pie Chart</span> <span id="bartitleMonth"></span></div>

<div class="row text-center" style="height: 100px;">

  <div class="col-12 bg-info h-75 w-100" >

    <!-- select month -->

    <div class="dropdown" style="float: left; margin:20px; font-weight:bold">

      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

        Select Month

		<span class="selectedMonth"></span>

      </button>

      <div class="dropdown-menu month" aria-labelledby="dropdownMenuButton">

        <a class="dropdown-item" href="#">November</a>

        <a class="dropdown-item" href="#">December</a>

        <a class="dropdown-item" href="#">January</a>

      </div>

    </div>

    <!-- select category -->

    <div class="dropdown" style="float: left; margin:20px; font-weight:bold"> 

      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

        Select Category

		<span class="selectedCategory"></span>

      </button>

      <div class="dropdown-menu category" aria-labelledby="dropdownMenuButton">

        <a class="dropdown-item" href="#">Wasting(%)</a>

        <a class="dropdown-item" href="#">Stunting(%)</a>

        <a class="dropdown-item" href="#">Underweight(%)</a>

        <a class="dropdown-item" href="#">Low Birth Weight(%)</a>

      </div>

    </div>



    <button type="button" class="btn btn-info" style="float: left; margin:20px" onclick="location.href=`{% url 'maha-feat2' %}`">Previous Feature</button>

    <button type="button" class="btn btn-info" style="float: left; margin:20px" onclick="location.href=`{% url 'maha-feat4' %}`">Next Feature</button>





   

    

  </div>

  

  <div class="col-12 m-5">

    <svg width="1100" height="750"></svg>

  </div>

  <div id="table" class="row h-50 bg-light justify-content-center ">

                        

  </div>

  

  

</div>



<div id="tooltip" class="hidden">

    <p><strong><span id="paraText"></span></strong><span id="value" style="font-weight: bold";> 100</span>%</p>

	<p><strong>Enrolled children contribution: </strong><span id="enrlval" style="font-weight: bold";>10</span>%</p>

</div>

{% endblock %}



{% block feature_js %}



<script>

      const svg = d3.select('svg');

  const width = +svg.attr('width');

  const height = +svg.attr('height');

  var radius = Math.min(width, height) / 3;

 var outerRadius1 = radius-10;



const render = data =>{



console.log(data);



  let arcInitial = d => d.wasting_percent;



  const margin = {left:400,top:350 ,right:170,bottom:20};

  const innerWidth = width - margin.left - margin.right;

  const innerHeight = height - margin.top - margin.bottom; 

  

  const g = svg.append('g')

      .attr('transform', `translate(${margin.left}, ${margin.top})`);



  var pie = d3.pie()



              .value(function(d) { 

                      return arcInitial(d); });



  var path = d3.arc()

              .outerRadius(radius -10)

              .innerRadius(0);

  var arcs = d3.arc()

.innerRadius(radius * 0.4)         // This is the size of the donut hole

.outerRadius(radius * 0.8);

 var label = d3.arc()

              .outerRadius(radius *1.1)

              .innerRadius(radius *0.9);







 

  var div = d3.select("body").append("div") 

      .attr("class", "tooltip")       

      .style("opacity", 0);



const onMouseOver = d =>{	

   div.transition().duration(100).style("opacity", 1);		

  div.html("<b>"+"<span id='paraText'>"+10+"</span>"+"</b><br>"+arcInitial(d.data)+"%");		



  

}





  oi = {"district_n":[],"wasting_percent":[],"stunting_percent":[],"underweight_percent":[],"low_birth_weight_percent":[], "per_no_enrld" :[]}

      

  data.forEach(d => {

      oi.district_n.push(d.district_n);

      oi.wasting_percent.push(d.wasting_percent);

      oi.stunting_percent.push(d.stunting_percent);

      oi.underweight_percent.push(d.underweight_percent);

      oi.low_birth_weight_percent.push(d.low_birth_weight_percent);

  oi.per_no_enrld.push(d.per_no_enrld);

      

  });



 var color = d3.scaleSequential().domain([d3.min(arcInitial(oi)),d3.max(arcInitial(oi))])

         .interpolator(d3.interpolateReds);

  var arc = g.selectAll(".arc");



var arcData = arc.data(pie(data));



  var arcEnter = arcData.enter().append("g")

                      .attr("class", "arc");



   



 

  arcEnter.append("path")

  .attr("fill", function(d) { 

          return color(arcInitial(d.data)); })

      .attr("d", path);

        

    

arcEnter.on("mouseover", function (d) {

    d3.select("#tooltip")

    .transition().duration(200)

     .style("left", d3.event.pageX + "px")

    .style("top",  d3.event.pageY - 30 + "px")		

    .select("#value").text(arcInitial(d.data))

    

    d3.select("#tooltip #enrlval").text(d.data["per_no_enrld"])

    

    d3.select("#tooltip").style("opacity", 1);	

    

})

  .on("mouseout", function () {

  // Hide the tooltip

  d3.select("#tooltip")

      .style("opacity", 0);;

});

  

  

      makeviz = opt =>{

  g.selectAll(".arc").remove();

         // arc.selectAll("*").remove();

              $( ".hello" ).remove();

              // console.log(d)





              let tansitionDuration = 1000;

                  if(opt == 'Wasting(%)'){

                  arcInitial  = d => d.wasting_percent;

              }else if (opt == 'Stunting(%)' ){

                  arcInitial  = d => d.stunting_percent; 

              }else if (opt == 'Underweight(%)' ){

                  arcInitial  = d => d.underweight_percent; 

              }

              else{

                  arcInitial  = d => d.low_birth_weight_percent;

              }

      

      console.log(arcInitial);

          var pie = d3.pie()

              .value(function(d) { 

                  return arcInitial(d); });

          

         

          var mycolor = d3.scaleSequential().domain([d3.min(arcInitial(oi)),d3.max(arcInitial(oi))])

                          .interpolator(d3.interpolateReds);





          var arcData = arc.data(pie(data));



          var arcEnter = arcData.enter().append("g")

              .attr("class", "arc");

    



    

  

  

  arcEnter.on("mouseover", function (d) {

    d3.select("#tooltip")

    .transition().duration(200)

     .style("left", d3.event.pageX + "px")

    .style("top",  d3.event.pageY - 30 + "px")		

    .select("#value").text(arcInitial(d.data))

    

    d3.select("#tooltip #enrlval").text(d.data["per_no_enrld"])

    

    d3.select("#tooltip").style("opacity", 1);	

    

})

  .on("mouseout", function () {

  // Hide the tooltip

  d3.select("#tooltip")

        .style("opacity", 0);;

});

  

  

  arcEnter.append("path").attr("fill", function(d) { 

          return mycolor(arcInitial(d.data)); })

      .attr("d", path);

    



    

var getAngle = function(d) {

        return (180 / Math.PI * (d.startAngle + d.endAngle) / 2 -90);

      };  		

                     

          

arcEnter

.append('polyline')

  .attr("stroke", "black")

  .style("fill", "none")

  .data(pie(data))

  .attr("stroke-width", 1)

  .attr('points', function(d) {

    var posA = arcs.centroid(d) ; // line insertion in the slice

    var posB = label.centroid(d) ;// line break: we use the other arc generator that has been built only for that

    var posC = label.centroid(d); // Label position = almost the same as posB

    var midangle = d.startAngle + (d.endAngle - d.startAngle) /2 // we need the angle to see if the X position will be at the extreme right or extreme left

    posC[0] = radius * 1.1 * (midangle < Math.PI ? 1 : -1); // multiply by 1 or -1 to put it on the right or on the left

    if(arcInitial(d.data)>0){

      return [posA, posB, posC]



    }

  })



// Add the polylines between chart and labels:

arcEnter

.append('text')

  .text( function(d) { if(arcInitial(d.data)>0){console.log(d.data.district_n) ; return d.data.district_n }} )

  .attr('transform', function(d) {

      var pos = label.centroid(d);

      var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2

      pos[0] = radius * 1.14 * (midangle < Math.PI ? 1 : -1);

      return 'translate(' + pos + ')';

  })

  .style('text-anchor', function(d) {

      var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2

      return (midangle < Math.PI ? 'start' : 'end')

  })

}   



      const dropdownChange = () =>{

          var sel = document.getElementById('opt');

          val = document.getElementById("opt").value

      }

      makeviz("Wasting(%)");

      $(".category a").click(function(){

   $(this).parents(".dropdown").find('.btn').html($(this).text() + ' <span class="selectedCategory"></span>');

  $(this).parents(".dropdown").find('.btn').val($(this).data('value'));

      var valCategory = $(this).text();

  var displayVal = valCategory.substring(0, valCategory.length-3);

  document.getElementById('paraText').innerHTML= displayVal+" Contribution: ";

  document.getElementById('bartitleCategory').innerHTML= displayVal+" : District-wise Contribution";

      makeviz(valCategory);



      });





}



$(function(){

//bind event

$(".month a").click(function(){

  var valMonth = $(this).text();

  $(this).parents('.dropdown').find('.dropdown-toggle').html(valMonth + ' <span class="selectedMonth"></span>');

 document.getElementById('bartitleMonth').innerHTML= valMonth;

});

 $(".category a").click(function(){

  var valCategory = $(this).text();

var displayVal = valCategory.substring(0, valCategory.length-3);



document.getElementById('paraText').innerHTML= displayVal+" Contribution: ";

document.getElementById('bartitleCategory').innerHTML= displayVal+" : District-wise Contribution";



  $(this).parents('.dropdown').find('.dropdown-toggle').html(valCategory + ' <span class="selectedCategory"></span>');

});



//trigger event

$('.month a').first().trigger('click');

$(".category a").first().trigger('click');



});







const monthwise = (data) => {

  data.forEach(d => {

          d.wasting_percent = +d.wasting_percent;

          d.stunting_percent = +d.stunting_percent;

          d.underweight_percent = +d.underweight_percent;

          d.low_birth_weight_percent = +d.low_birth_weight_percent;

          d.per_no_enrld = +d.per_no_enrld;

      });



      var aproperty = [];

      var sproperty = [];

      var oproperty = [];

  data.forEach(d =>{

      var temp = {};

      temp['district_n'] = d.district_n;

      temp['wasting_percent'] = d.wasting_percent;

      temp['stunting_percent'] = d.stunting_percent;

      temp['underweight_percent'] = d.underweight_percent;

      temp['low_birth_weight_percent'] = d.low_birth_weight_percent;

      temp['per_no_enrld'] = d.per_no_enrld;

      if(d.month_n == "Nov"){

          aproperty.push(temp);

      }else if (d.month_n == "Dec"){

          sproperty.push(temp);

      }else if (d.month_n == "Jan"){

          oproperty.push(temp);

      }

    

  })



  var listdata = [

      aproperty,sproperty,oproperty

  ]

  return listdata;

  }



  const selectData =  (val,monthwiseData) =>{

  if(val == "November"){

          return monthwiseData[0];

      }else if (val == "December"){

          return monthwiseData[1];

      }else if (val == 'January'){

          return monthwiseData[2]       

      }

  } 



    



    d3.csv("{% static 'maha_dashboard/data/csv/f3.csv' %}").then(data => {

        monthwiseData = monthwise(data);

  d3.select("#monthdropdown")

  .on("change", () =>{

          val = document.getElementById("monthdropdown").value

          mydata = selectData(val,monthwiseData);

          svg.selectAll("*").remove();

          render(mydata);

      });

  

      $(".month a").click(function(){

      var val = $(this).text();

      $(this).parents(".dropdown").find('.btn').html($(this).text() + ' <span class="selectedMonth"></span>');

$(this).parents(".dropdown").find('.btn').val($(this).data('value'));

      var valMonth = $(this).text();

   document.getElementById('bartitleMonth').innerHTML= valMonth;



      mydata = selectData(val,monthwiseData);

      svg.selectAll("*").remove();

      render(mydata);



  });

  

  augData = monthwiseData[0];

  render(augData); 

  })

    </script>



{% endblock %}

